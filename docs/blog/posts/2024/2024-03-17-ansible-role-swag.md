---
authors: [bsmeding]
toc: true
draft: true
date: 2024-03-17
layout: single
comments: true
title: Ansible Role - SWAG
tags: ["ansible", "swag", "docker", "linuxserver"]
---

We've released a new Ansible Role to deploy the SWAG (Secure Web Application Gateway) reverse-proxy server created by (linuxserver.io)[https://www.linuxserver.io/]
This Ansible role will install the Docker image on Linux systems running docker with the SWAG docker image


# Info from Linuxserver docker image
full readme (here)[https://github.com/linuxserver/docker-swag]

SWAG - Secure Web Application Gateway (formerly known as letsencrypt, no relation to Let's Encryptâ„¢) sets up an Nginx webserver and reverse proxy with php support and a built-in certbot client that automates free SSL server certificate generation and renewal processes (Let's Encrypt and ZeroSSL). It also contains fail2ban for intrusion prevention.

## Certbot Plugins

SWAG includes many Certbot plugins out of the box, but not all plugins can be included. If you need a plugin that is not included, the quickest way to have the plugin available is to use our Universal Package Install Docker Mod.

Set the following environment variables on your container:

DOCKER_MODS=linuxserver/mods:universal-package-install
INSTALL_PIP_PACKAGES=certbot-dns-<plugin>

Set the required credentials (usually found in the plugin documentation) in /config/dns-conf/<plugin>.ini. It is recommended to attempt obtaining a certificate with STAGING=true first to make sure the plugin is working as expected.
Security and password protection
```
The container detects changes to url and subdomains, revokes existing certs and generates new ones during start.
Per RFC7919, the container is shipping ffdhe4096 as the dhparams.pem.
If you'd like to password protect your sites, you can use htpasswd. Run the following command on your host to generate the htpasswd file docker exec -it swag htpasswd -c /config/nginx/.htpasswd <username>
You can add multiple user:pass to .htpasswd. For the first user, use the above command, for others, use the above command without the -c flag, as it will force deletion of the existing .htpasswd and creation of a new one
You can also use ldap auth for security and access control. A sample, user configurable ldap.conf is provided, and it requires the separate image linuxserver/ldap-auth to communicate with an ldap server.
```

## Site config and reverse proxy

The default site config resides at /config/nginx/site-confs/default.conf. Feel free to modify this file, and you can add other conf files to this directory. However, if you delete the default file, a new default will be created on container start.
Preset reverse proxy config files are added for popular apps. See the README.md file under /config/nginx/proxy_confs for instructions on how to enable them. The preset confs reside in and get imported from this repo.
If you wish to hide your site from search engine crawlers, you may find it useful to add this configuration line to your site config, within the server block, above the line where ssl.conf is included add_header X-Robots-Tag "noindex, nofollow, nosnippet, noarchive"; This will ask Google et al not to index and list your site. Be careful with this, as you will eventually be de-listed if you leave this line in on a site you wish to be present on search engines
If you wish to redirect http to https, you must expose port 80

## Using certs in other containers

    This container includes auto-generated pfx and private-fullchain-bundle pem certs that are needed by other apps like Emby and Znc.
        To use these certs in other containers, do either of the following:
        (Easier) Mount the container's config folder in other containers (ie. -v /path-to-swag-config:/swag-ssl) and in the other containers, use the cert location /swag-ssl/keys/letsencrypt/
        (More secure) Mount the SWAG folder etc that resides under /config in other containers (ie. -v /path-to-swag-config/etc:/swag-ssl) and in the other containers, use the cert location /swag-ssl/letsencrypt/live/<your.domain.url>/ (This is more secure because the first method shares the entire SWAG config folder with other containers, including the www files, whereas the second method only shares the ssl certs)
        These certs include:
        cert.pem, chain.pem, fullchain.pem and privkey.pem, which are generated by Certbot and used by nginx and various other apps
        privkey.pfx, a format supported by Microsoft and commonly used by dotnet apps such as Emby Server (no password)
        priv-fullchain-bundle.pem, a pem cert that bundles the private key and the fullchain, used by apps like ZNC

## Using fail2ban

    This container includes fail2ban set up with 5 jails by default:
        nginx-http-auth
        nginx-badbots
        nginx-botsearch
        nginx-deny
        nginx-unauthorized
    To enable or disable other jails, modify the file /config/fail2ban/jail.local
    To modify filters and actions, instead of editing the .conf files, create .local files with the same name and edit those because .conf files get overwritten when the actions and filters are updated. .local files will append whatever's in the .conf files (ie. nginx-http-auth.conf --> nginx-http-auth.local)
    You can check which jails are active via docker exec -it swag fail2ban-client status
    You can check the status of a specific jail via docker exec -it swag fail2ban-client status <jail name>
    You can unban an IP via docker exec -it swag fail2ban-client set <jail name> unbanip <IP>
    A list of commands can be found here: https://www.fail2ban.org/wiki/index.php/Commands

## Updating configs

    This container creates a number of configs for nginx, proxy samples, etc.
    Config updates are noted in the changelog but not automatically applied to your files.
    If you have modified a file with noted changes in the changelog:
        Keep your existing configs as is (not broken, don't fix)
        Review our repository commits and apply the new changes yourself
        Delete the modified config file with listed updates, restart the container, reapply your changes
    If you have NOT modified a file with noted changes in the changelog:
        Delete the config file with listed updates, restart the container
    Proxy sample updates are not listed in the changelog. See the changes here: https://github.com/linuxserver/reverse-proxy-confs/commits/master
    Proxy sample files WILL be updated, however your renamed (enabled) proxy files will not.
    You can check the new sample and adjust your active config as needed.


## Example Playbook

This example will install Docker and install reverse proxy container SWAG with most defaults.
Please set the `swag__url` to you're own domain, and subdomains when needed.
All other variables possible with defaults see next chapter

!NOTE
Please note that this example playbook also use another role named `bsmeding.docker` that will install docker on a system. To install this role first install with `ansible-galaxy role install bsmeding.docker` or install docker on forehand and comment the first taks out.


```yaml
---
- name: Install DMZ
  hosts: [dmz]
  gather_facts: true
  become: yes
  vars:
    swag__port_web: 80
    swag__port_ssh: 443
    swag__url: 'example.com'
    swag__subdomains: 'www'
    swag__validation: 'http'
  tasks:
    - name: Check if docker is installed
      ansible.builtin.include_role:
        name: bsmeding.docker

    - name: Check if SWAG is installed
      ansible.builtin.include_role:
        name: docker_swag
```

### Subdomain reverse proxy
To use the reverse proxy possibilities, there are templates available that can be used with limit information, you don't have tu create Nginx config files yourself

For example if you want to point `https://dash.example.com` to another server in your network on IP `http://192.168.111.241` port `9090` you can add this to the list `swag__proxy_confs_subdomain`
```yaml
swag__proxy_confs_subdomain:
  - server_name: dash.example.com
    listen: 443
    default_upstream_proto: http
    default_upstream_url: 192.168.1.10
    default_upstream_port: 9090
```

## Variables

| Variable                            | Default Value                                       | Description                                                                                           |
|-------------------------------------|-----------------------------------------------------|-------------------------------------------------------------------------------------------------------|
| `swag__name`                        | `swag`                                              | The name of the container.                                                                            |
| `swag__image`                       | `lscr.io/linuxserver/swag`                          | The Docker image to use for SWAG.                                                                     |
| `swag__port_web`                    | `80`                                                | Port for web traffic.                                                                                 |
| `swag__port_ssh`                    | `443`                                               | Port for SSH/SSL traffic.                                                                             |
| `swag__skip_setup`                  | `false`                                             | Set to `true` to disable the setup stage of the SWAG image.                                           |
| `swag__url`                         | `'example.com'`                                     | The base URL for the SWAG setup.                                                                      |
| `swag__subdomains`                  | `'www'`                                             | Subdomains for the SWAG setup.                                                                        |
| `swag__validation`                  | `'http'`                                            | Method of validation (`http` or `dns`).                                                               |
| `swag__certprovider`                | `''` (optional)                                     | Certificate provider (e.g., `zerossl`).                                                               |
| `swag__dnsplugin`                   | `''` (optional)                                     | DNS plugin (e.g., `cloudflare`).                                                                      |
| `swag__cloudflare_global_email`     | `''` (optional)                                     | Cloudflare global email (if using Cloudflare DNS plugin).                                             |
| `swag__cloudflare_global_api`       | `''` (optional)                                     | Cloudflare global API key (if using Cloudflare DNS plugin).                                           |
| `swag__cloudflare_api_token`        | `''` (optional)                                     | Cloudflare API token (if using Cloudflare DNS plugin).                                                |
| `swag__email`                       | `'mail@example.com'`                                | Email for certificate provider notifications.                                                          |
| `swag__only_subdomains`             | `'false'`                                           | Use only subdomains for the SSL certificate.                                                          |
| `swag__extra_domain`                | `''`                                                | Additional domains for the SSL certificate.                                                           |
| `swag__staging`                     | `'true'`                                            | Use staging environment (recommended for testing with Let's Encrypt).                                 |
| `swag__docker_mods`                 | `'linuxserver/mods:swag-cloudflare-real-ip'`        | Docker mods to use with SWAG.                                                                         |
| `swag__remove_existing_container`   | `no`                                                | Remove any existing container before creating a new one.                                              |
| `swag__remove_existing_home_dir`    | `no`                                                | Removes the home directory (for testing purposes only!).                                              |
| `swag__pull_image`                  | `yes`                                               | Pull the Docker image if not already pulled.                                                          |
| `swag__network_mode`                | `'default'`                                         | Network mode for Docker container.                                                                    |
| `swag__network_cidr`                | `'172.16.81.0/26'`                                  | CIDR for network configuration.                                                                       |
| `swag__network`                     | `'proxy'`                                           | Network to connect the container to.                                                                  |
| `swag__container_networks`          | `[{'name': 'bridge'}, {'name': swag__network}]`     | List of networks for the container to join.                                                           |
| `swag__purge_networks`              | `no`                                                | Remove all networks upon container removal.                                                           |
| `swag__log_driver`                  | `'json-file'`                                       | Log driver for Docker.                                                                                |
| `swag__log_options`                 | `{}`                                                | Additional options for the log driver.                                                                |
| `swag__home`                        | `"/opt/{{ swag__name }}"`                           | Home directory for SWAG files.                                                                        |
| `swag__use_local_directories_instead_of_volumes` | `true`                  | Use mapped folders instead of volumes (volumes not set up).                                           |
| `swag__directories`                 | List of directories with paths and permissions      | Directories to create with specific permissions.                                                      |
| `swag__ports`                       | `["{{ swag__port_web }}:80", "{{ swag__port_ssh }}:443"]` | Ports to expose for SWAG container.                                                      |
| `swag__directory_volumes`           | `["{{ swag__home }}/config:/config"]`               | Directory volumes for the container.                                                                  |
| `swag__file_volumes`                | `["/var/run/docker.sock:/var/run/docker.sock:ro"]`  | File volumes for the container.                                                                       |
| `swag__default_env`                 | Various defaults (see below)                        | Default environment variables for the SWAG container.                                                 |
| `swag__env`                         | `{}`                                                | Additional environment variables.                                                                     |
| `swag__proxy_confs_subdomain`       | List of subdomain configuration proxies             | Subdomain proxy configurations for different applications.                                            |

### Default Environment Variables (`swag__default_env`)

- `TZ`: Time zone for the container (default: `Europe/Paris`).
- `PUID`: User ID for Docker (default: `1040`).
- `PGID`: Group ID for Docker (default: `1001`).
- `URL`: Base URL for SWAG.
- `SUBDOMAINS`: Subdomains to use (default: `www`).
- `VALIDATION`: Validation method (default: `http`).
- `CERTPROVIDER`: Certificate provider (optional).
- `DNSPLUGIN`: DNS plugin (optional).
- `EMAIL`: Email for certificate notifications.
- `ONLY_SUBDOMAINS`: Use only subdomains (default: `false`).
- `EXTRA_DOMAINS`: Extra domains for SSL (optional).
- `STAGING`: Use staging environment for testing (default: `false`).
- `DOCKER_MODS`: Docker mods (optional).
- `CF_ZONE_ID`, `CF_ACCOUNT_ID`, `CF_API_TOKEN`: Cloudflare credentials if using Cloudflare DNS validation.

## Proxy Configuration Examples

In `swag__proxy_confs_subdomain`, you can configure additional subdomain proxies as follows:

```yaml
swag__proxy_confs_subdomain:
  - server_name: dash.example.com
    listen: 443
    enable_ldap: false
    enable_authelia: true
    default_upstream_proto: http
    default_upstream_url: dashboard
    default_upstream_port: 9090
  - server_name: app1.example.com
    listen: 443
    enable_ldap: false
    enable_authelia: false
    default_upstream_proto: http
    default_upstream_url: 192.168.1.10
    default_upstream_port: 8080
```
